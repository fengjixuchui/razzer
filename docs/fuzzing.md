# Instruction: How to run Razzer

To run Razzer, one should build a kernel first. To build a kernel,

```
cd tools/race-syzkaller/kernel-build/
./build-kernel.sh --config CONFIG_FILE
```

For example, if the target kernel version is v4.17,

```
cd tools/race-syzkaller/kernel-build/
./build-kernel.sh --config config-v4.17-syzkaller
```

Razzer requires two necessary tools, QEMU and the modified Syzkaller.
To build QEMU,

```
./scripts/qemu/install.sh
```

To build the modified Syzkaller,

```
./scripts/syzkaller/install.sh
```

To run Razzer, one can execute the `run.sh` script with a syzkaller
configuration file.

```
cd tools/race-syzkaller/exp/
./run.sh --config configs/kernel/config
```

# Hypervisor

Razzer leverages the modified hypervisor to schedule vCPUs
deterministically.

## Deterministic scheduler

KVM is designed such that a host thread serves a virtual CPU in a
guest machine. Therefore, scheduling vCPUs instead of guest threads is
possible and this is how Razzer works. Razzerâ€™s modified hypervisor
provides the following features for the guest userprogram: (i) setting
up a breakpoint per CPU core (more precisely, per virtual CPU core as
they run on a virtual machine); (ii) resuming the execution of kernel
threads after the guest kernel hits breakpoints; and (iii) checking
whether a race truly occurred due to a guest kernel.

All of these features are provided through hypercall interfaces used
by syz-scheduler.

# Fuzzer

Razzer modifies Syzkaller to take advantages of the modified
hypervisor. It consists of two phases fuzzer, called syz-fuzzer and
syz-scheduler, that each phase runs on an independent virtual machine.

## syz-fuzzer

Syz-fuzzer focuses on identifying a single-thread input program that
executes potential race points generated by the static analysis.
Syz-fuzzer is similar with Syzkaller except that it figure out inputs
that contains two syscalls that execute each instruction of potential
race points, and sends it to syz-scheduler.

## syz-scheduler

Syz-scheduler is constructed with the help from the syz-fuzzer,
utilizing a custom hypervisor to control the thread interleaving
deterministically. It executes a hypercall to install a breakpoint
right before the syscall that execute an instruction of the potential
race point. Syz-scheduler also mutates inputs further that turns out
that a race truly occurs at the potential race points.

